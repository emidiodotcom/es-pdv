{% extends 'base.html' %}

{% block title %}PDV{% endblock title %}

{% block content %}
<main>

<section class="product-pane">
  <div class="categories">
    <button class="active" onclick="filterProducts('all')">Todos</button>
    {% for cat in product_categories %}
      <button onclick="filterProducts('{{ cat.id }}')">{{ cat.name }}</button>
    {% endfor %}
  </div>

  <div class="products">
    {% for prod in products %}
    <div class="product" onclick="addProduct('{{ prod.id }}')"
        data-id="{{ prod.id }}"
        data-category="{{ prod.category.id }}"
        title="({{ prod.id }}) {{ prod.name }}">
      <img
      {% if prod.image %}
          src="{{ prod.image.url }}"
      {% else %}
          src="/media/default-product.png"
      {% endif %}
          alt="[{{ prod.name }}]">
      <div class="product-name">{{ prod.name }}</div>
      <div class="product-price">R$ {{ prod.price }}</div>
    </div>
    {% endfor %}
  </div>
</section>

<section class="order-pane" id="content">
  <div class="query">
    <input type="text" id="search-products" placeholder="Nome ou ID..."
        onkeyup="searchProducts()">
    <button title="Leitor código barras" class="barcode"
        onclick="alert('Sem suporte no momento!')">
      <svg>
        <rect x="0"  y="2" width="2" height="28" fill="black"/>
        <rect x="4"  y="2" width="4" height="28" fill="black"/>
        <rect x="11" y="2" width="2" height="28" fill="black"/>
        <rect x="16" y="2" width="6" height="28" fill="black"/>
        <rect x="25" y="2" width="3" height="28" fill="black"/>
      </svg>
    </button>
  </div>

  <table class="orders">
    <thead>
      <tr>
        <th>#</th>
        <th>Produto</th>
        <th>Qtde</th>
        <th>Unitário</th>
        <th>Total</th>
      </tr>
    </thead>
    <tbody>
      {% for item in order.products.all %}
      <tr>
        <td>{{ forloop.counter }}</td>
        <td>{{ item.product.name }}</td>
        <td>{{ item.quantity }}</td>
        <td>R$ {{ item.product.price }}</td>
        <td>R$ {{ item.subtotal }}</td>
      </tr>
      {% empty %}
      <tr><td colspan="5">Nenhum item no pedido</td></tr>
      {% endfor %}
    </tbody>
  </table>
  <div class="order-total">
    Valor Total: R$ {{ order.total|default:'0,00' }}
  </div>
  <div class="actions">
    <button class="cancel" onclick="cancelOrder()">Cancelar</button>
    <button class="accept" onclick="">Receber e Finalizar</button>
  </div>
</section>

</main>

<footer class="order">
  <span>
  {% if order %}
    Pedido: {{ order.id }}
  {% else %}
    Nenhum pedido
  </span>
  {% endif %}
</footer>

<dialog id="payment-dialog">
  <h2>Pagamento</h2>
  <form method="POST" action="">
    {% csrf_token %}
    {{ add_payment_form.method }}
    {{ add_payment_form.amount }}
    <button type="submit" class="accept">Confirmar</button>
    <button type="button" class="cancel" onclick="hidePayment()">Cancelar</button>
  </form>
</dialog>

<script>
function filterProducts(categoryId) {
  const buttons = document.querySelectorAll('.categories button');
  buttons.forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');

  const products = document.querySelectorAll('.product');
  products.forEach(p => {
    if (categoryId === 'all' || categoryId === p.dataset.category) {
      p.style.display = 'block';
    } else {
      p.style.display = 'none';
    }
  });
}

function searchProducts() {
  const query = document.getElementById('search-products').value.toLowerCase();
  const products = document.querySelectorAll('.product');

  if (!query) {
    products.forEach(p => p.style.display = 'block');
    return;
  }

  const firstChar = query.charAt(0);
  if (!isNaN(firstChar)) {
    products.forEach(p =>
      p.style.display = (query === p.dataset.id) ? 'block' : 'none'
    );
  } else {
    products.forEach(p => {
      const name = p.querySelector('.product-name').innerText.toLowerCase();
      p.style.display = name.includes(query) ? 'block' : 'none';
    });
  }
}

function addProduct(productId) {
  const form = document.createElement('form');
  form.method = 'POST';
  form.style.display = 'none';
  form.innerHTML = '{% csrf_token %}' +
                   '<input type="hidden" name="product" value="' + productId + '">' +
                   '<input type="hidden" name="quantity" value="1">' +
                   '<input type="hidden" name="action" value="add_product">';
  document.body.appendChild(form);
  form.submit();
}

document.getElementById('search-products').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    const visibleProducts = Array.from(document.querySelectorAll('.product'))
      .filter(p => p.style.display !== 'none');

    if (visibleProducts.length === 1) {
      const productId = visibleProducts[0].dataset.id;
      addProduct(productId);
      this.value = '';
    }
  }
});

function cancelOrder() {
  if(confirm('Deseja realmente cancelar o pedido?')) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.style.display = 'none';
    form.innerHTML = '{% csrf_token %}' +
                     '<input type="hidden" name="action" value="cancel_order">';
    document.body.appendChild(form);
    form.submit();
  }
}

function showPayment() {
  document.getElementById('payment-dialog').showModal();
}

function hidePayment() {
  document.getElementById('payment-dialog').close();
}
</script>

{% endblock content %}
