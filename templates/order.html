{% extends 'base.html' %}

{% block title %}PDV{% endblock title %}

{% block content %}
<main>

<section class="product-pane">
  <div class="categories">
    <button class="active" onclick="filterProducts('all')">Todos</button>
    {% for cat in product_categories %}
      <button onclick="filterProducts('{{ cat.id }}')">{{ cat.name }}</button>
    {% endfor %}
  </div>

  <div class="products">
    {% for prod in products %}
    <div class="product" onclick="addProduct('{{ prod.id }}')"
        data-category="{{ prod.category.id }}"
        title="{{ prod.name }}">
      <img
      {% if prod.image %}
          src="{{ prod.image.url }}"
      {% else %}
          src="/media/default-product.png"
      {% endif %}
          alt="[{{ prod.name }}]">
      <div class="product-name">{{ prod.name }}</div>
      <div class="product-price">R$ {{ prod.price }}</div>
    </div>
    {% endfor %}
  </div>
</section>

<section class="order-pane">
  <table class="orders">
    <thead>
      <tr>
        <th>#</th>
        <th>Produto</th>
        <th>Qtde</th>
        <th>Unit√°rio</th>
        <th>Total</th>
      </tr>
    </thead>
    <tbody>
      {% for item in order.products.all %}
      <tr>
        <td>{{ forloop.counter }}</td>
        <td>{{ item.product.name }}</td>
        <td>{{ item.quantity }}</td>
        <td>R$ {{ item.product.price }}</td>
        <td>R$ {{ item.subtotal }}</td>
      </tr>
      {% empty %}
      <tr><td colspan="5">Nenhum item no pedido</td></tr>
      {% endfor %}
    </tbody>
  </table>
  <div class="order-total">
    Valor Total: R$ {{ order.total|default:'0,00' }}
  </div>
  <div class="actions">
    <button class="cancel" onclick="cancelOrder()">Cancelar</button>
    <button class="accept" onclick="">Receber e Finalizar</button>
  </div>
</section>

</main>

<footer class="order">
  <span>
  {% if order %}
    Pedido: {{ order.id }}
  {% else %}
    Nenhum pedido
  </span>
  {% endif %}
</footer>

<dialog id="payment-dialog">
  <h2>Pagamento</h2>
  <form method="POST" action="">
    {% csrf_token %}
    {{ add_payment_form.method }}
    {{ add_payment_form.amount }}
    <button type="submit" class="accept">Confirmar</button>
    <button type="button" class="cancel" onclick="hidePayment()">Cancelar</button>
  </form>
</dialog>

<script>
function filterProducts(categoryId) {
  const buttons = document.querySelectorAll('.categories button');
  buttons.forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');

  const products = document.querySelectorAll('.product');
  products.forEach(prod => {
    if (categoryId === 'all' || prod.dataset.category === categoryId) {
      prod.style.display = 'block';
    } else {
      prod.style.display = 'none';
    }
  });
}

function addProduct(productId) {
  const form = document.createElement('form');
  form.method = 'POST';
  form.style.display = 'none';
  form.innerHTML = '{% csrf_token %}' +
                   '<input type="hidden" name="product" value="' + productId + '">' +
                   '<input type="hidden" name="quantity" value="1">' +
                   '<input type="hidden" name="action" value="add_product">';
  document.body.appendChild(form);
  form.submit();
}

function cancelOrder() {
  if(confirm('Deseja realmente cancelar o pedido?')) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.style.display = 'none';
    form.innerHTML = '{% csrf_token %}' +
                     '<input type="hidden" name="action" value="cancel_order">';
    document.body.appendChild(form);
    form.submit();
  }
}

function showPayment() {
  document.getElementById('payment-dialog').showModal();
}

function hidePayment() {
  document.getElementById('payment-dialog').close();
}
</script>

{% endblock content %}
